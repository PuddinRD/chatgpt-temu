<!DOCTYPE html>
<html lang="es" data-theme="light">

<head>
  <meta charset="UTF-8">
  <link rel="shortcut icon" href="icon.webp" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi App con Gemini AI</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="theme-toggle-container">
    <button id="themeToggle" title="Cambiar modo claro/oscuro">üåû</button>
  </div>

  <div class="container">
    <div style="text-align: center;">
      <img src="icon.webp" alt="Avatar" style="width: 70px; height: 70px; border-radius: 50%; font-size: 25px;">
    </div>
    <h1>üõ†Ô∏èüè¥‚Äç‚ò†Ô∏èü¶ú Bienvenidos al ChatGPT de TEMU üè¥‚Äç‚ò†Ô∏èüòÉüöÄ</h1>

    <div class="prompt-section">
      <textarea class="prompt-area" id="promptInput" placeholder="Escribe tu consulta aqu√≠..."></textarea>
      <div class="button-group">
        <button id="executeBtn" title="Enviar consulta">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
            <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/>
          </svg>
          Enviar
        </button>
        <button id="clearBtn" title="Limpiar consulta y resultado">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eraser" viewBox="0 0 16 16">
            <path d="M8.086 2.207a2 2 0 0 1 2.828 0l3.879 3.879a2 2 0 0 1 0 2.828l-5.5 5.5A2 2 0 0 1 7.879 15H5.12a2 2 0 0 1-1.414-.586l-2.5-2.5a2 2 0 0 1 0-2.828zm2.121.707a1 1 0 0 0-1.414 0L4.16 7.547l5.293 5.293 4.633-4.633a1 1 0 0 0 0-1.414zM8.746 13.547 3.453 8.254 1.914 9.793a1 1 0 0 0 0 1.414l2.5 2.5a1 1 0 0 0 .707.293H7.88a1 1 0 0 0 .707-.293z"/>
          </svg>
          Limpiar
        </button>
      </div>
    </div>

    <div class="result-container">
      <div class="result-header">
        <h3>Respuesta de la IA:</h3>
        <div class="result-actions">
          <button id="copyBtn" title="Copiar al portapapeles" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
              <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/>
              <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/>
            </svg>
            Copiar
          </button>
          <button id="saveBtn" title="Guardar como .txt" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
              <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
              <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/>
            </svg>
            Guardar
          </button>
        </div>
      </div>
      <div id="resultBox" class="result-box">Esperando consulta...</div>
    </div>
  </div>

  <div class="loading" id="loading" style="display: none;">
    <div class="spinner"></div>
    <span>Cargando...</span>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

  <script>
    const executeBtn = document.getElementById('executeBtn');
    const clearBtn = document.getElementById('clearBtn');
    const promptInput = document.getElementById('promptInput');
    const resultBox = document.getElementById('resultBox');
    const loadingIndicator = document.getElementById('loading');
    const copyBtn = document.getElementById('copyBtn');
    const saveBtn = document.getElementById('saveBtn');
    const themeToggleBtn = document.getElementById('themeToggle');

    copyBtn.disabled = true;
    saveBtn.disabled = true;

    const currentTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', currentTheme);
    themeToggleBtn.textContent = currentTheme === 'light' ? 'üåû' : 'üåú';

    themeToggleBtn.addEventListener('click', () => {
      let targetTheme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', targetTheme);
      localStorage.setItem('theme', targetTheme);
      themeToggleBtn.textContent = targetTheme === 'light' ? 'üåû' : 'üåú';
    });

    executeBtn.addEventListener('click', executeQuery);
    clearBtn.addEventListener('click', clearAll);
    copyBtn.addEventListener('click', copyToClipboard);
    saveBtn.addEventListener('click', saveAsTextFile);

    // Agregar controlador de eventos para el evento 'keydown'
    promptInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault(); // Evita que se inserte una nueva l√≠nea
        executeQuery();
      }
    });

    async function executeQuery() {
      const prompt = promptInput.value.trim();
      if (!prompt) {
        showNotification('Por favor, escribe una consulta.');
        return;
      }
      showLoading();
      resultBox.textContent = 'Procesando...';
      copyBtn.disabled = true;
      saveBtn.disabled = true;

      try {
        const response = await fetch('https://tu-app.vercel.app/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: prompt }),
        });

        if (!response.ok) {
          let errorMsg = 'Error al comunicarse con el servidor.';
          try {
            const errorData = await response.json();
            errorMsg = `Error ${response.status}: ${errorData.error || 'Detalles no disponibles.'}`;
          } catch (e) {
            errorMsg = `Error ${response.status}: ${response.statusText}`;
          }
          throw new Error(errorMsg);
        }

        const data = await response.json();

        if (data.candidates && data.candidates.length > 0 && data.candidates[0].content?.parts?.length > 0) {
          const contentPart = data.candidates[0].content.parts[0];
          if (contentPart.text) {
            displayResult(contentPart.text);
            copyBtn.disabled = false;
            saveBtn.disabled = false;
          } else {
            console.warn('La parte de contenido no contiene texto:', contentPart);
            resultBox.innerHTML = '<span class="error-message">La respuesta no contiene texto legible.</span>';
            copyBtn.disabled = true;
            saveBtn.disabled = true;
          }
        } else {
          console.warn('Respuesta inesperada o vac√≠a de la API:', data);
          resultBox.innerHTML = '<span class="error-message">No se recibi√≥ una respuesta v√°lida del modelo.</span>';
          copyBtn.disabled = true;
          saveBtn.disabled = true;
        }
      } catch (error) {
        console.error('Error en executeQuery:', error);
        resultBox.innerHTML = `<span class="error-message">Error: ${error.message}</span>`;
        copyBtn.disabled = false;
        saveBtn.disabled = false;
      } finally {
        hideLoading();
      }
    }

    function displayResult(text) {
      resultBox.innerHTML = marked.parse(text);
      Prism.highlightAllUnder(resultBox);
    }

    async function copyToClipboard() {
      const textToCopy = resultBox.innerText;
      if (!textToCopy || resultBox.textContent === 'Esperando consulta...' || resultBox.textContent === 'Procesando...') {
        showNotification('No hay resultado para copiar.');
        return;
      }
      try {
        await navigator.clipboard.writeText(textToCopy);
        const originalHTML = copyBtn.innerHTML;
        copyBtn.textContent = '¬°Copiado!';
        copyBtn.disabled = true;
        setTimeout(() => {
          copyBtn.innerHTML = originalHTML;
          copyBtn.disabled = false;
        }, 1500);
      } catch (err) {
        console.error('Error al copiar:', err);
        showNotification('No se pudo copiar el texto.');
      }
    }

    function saveAsTextFile() {
      const textToSave = resultBox.innerText;
      if (!textToSave || resultBox.textContent === 'Esperando consulta...' || resultBox.textContent === 'Procesando...') {
        showNotification('No hay resultado para guardar.');
        return;
      }
      try {
        const blob = new Blob([textToSave], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const anchor = document.createElement('a');
        anchor.href = url;
        const timestamp = new Date().toISOString().slice(0, 10);
        anchor.download = `gemini-respuesta-${timestamp}.txt`;
        document.body.appendChild(anchor);
        anchor.click();
        document.body.removeChild(anchor);
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('Error al guardar archivo:', error);
        showNotification('Ocurri√≥ un error al intentar guardar el archivo.');
      }
    }

    function showLoading() {
      loadingIndicator.style.display = 'flex';
      executeBtn.disabled = true;
      clearBtn.disabled = true;
    }

    function hideLoading() {
      loadingIndicator.style.display = 'none';
      executeBtn.disabled = false;
      clearBtn.disabled = false;
    }

    function clearAll() {
      promptInput.value = '';
      resultBox.innerHTML = 'Esperando consulta...';
      copyBtn.disabled = true;
      saveBtn.disabled = true;
    }

    function showNotification(message) {
      alert(message);
    }
  </script>
</body>

</html>
